<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>Flask源码阅读之Werkzeug | Seventysix&#39;s blog</title><meta name="description" content="概述 Flask核心功能依赖于两个库：Jinja和Werkzeug。前者作为Flask的模版（Template）引擎，提供了Flask创建模版以及相关功能的支持；后者作为一个wsgi工具库，为Flask实现核心功能提供了支持。本文主要通过对Flask源码的阅读，学习下其核心功能是如何实现的，以及Werkzeug起到了一个什么作用。  Flask应用启动 Flask官方建议在生产环境中，不要使用其"><meta property="og:type" content="article"><meta property="og:title" content="Flask源码阅读之Werkzeug"><meta property="og:url" content="http://example.com/2023/01/30/Flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BWerkzeug/index.html"><meta property="og:site_name" content="Seventysix&#39;s blog"><meta property="og:description" content="概述 Flask核心功能依赖于两个库：Jinja和Werkzeug。前者作为Flask的模版（Template）引擎，提供了Flask创建模版以及相关功能的支持；后者作为一个wsgi工具库，为Flask实现核心功能提供了支持。本文主要通过对Flask源码的阅读，学习下其核心功能是如何实现的，以及Werkzeug起到了一个什么作用。  Flask应用启动 Flask官方建议在生产环境中，不要使用其"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://i.328888.xyz/2023/01/31/8GNp5.md.png"><meta property="og:image" content="https://i.328888.xyz/2023/02/01/IWUpL.png"><meta property="article:published_time" content="2023-01-30T13:10:03.000Z"><meta property="article:modified_time" content="2023-02-02T13:10:03.000Z"><meta property="article:author" content="Seventysix"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.328888.xyz/2023/01/31/8GNp5.md.png"><link rel="canonical" href="http://example.com/2023/01/30/Flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BWerkzeug/index.html"><link rel="alternate" href="/atom.xml" title="Seventysix&#39;s blog" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><meta name="generator" content="Hexo 6.3.0"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/Seventysix" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Seventysix</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">高级测试开发工程师</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shanghai, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/Seventysix" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a><span class="category-list-count">3</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/Android/" style="font-size:14px">Android</a> <a href="/tags/Flask/" style="font-size:13px">Flask</a> <a href="/tags/blog/" style="font-size:13px">blog</a> <a href="/tags/dump/" style="font-size:13px">dump</a> <a href="/tags/%E6%B3%A8%E5%85%A5/" style="font-size:13.5px">注入</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">3</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2023/01/30/Flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BWerkzeug/" class="title">Flask源码阅读之Werkzeug</a></p><p class="item-date"><time datetime="2023-01-30T13:10:03.000Z" itemprop="datePublished">2023-01-30</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a></p><p class="item-title"><a href="/2023/01/25/Flask%E5%BB%BA%E7%AB%99%E8%87%AA%E7%94%A8%E6%A0%87%E9%85%8D/" class="title">Flask建站自用标配</a></p><p class="item-date"><time datetime="2023-01-25T06:54:31.000Z" itemprop="datePublished">2023-01-25</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/blog/">blog</a></p><p class="item-title"><a href="/2023/01/23/hello-world/" class="title">Hello World</a></p><p class="item-date"><time datetime="2023-01-23T07:46:04.068Z" itemprop="datePublished">2023-01-23</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2022/12/14/Android-so%E6%96%87%E4%BB%B6%E7%9A%84%E5%8A%A0%E8%A7%A3%E5%AF%86/" class="title">Android so文件的加解密</a></p><p class="item-date"><time datetime="2022-12-14T14:10:02.000Z" itemprop="datePublished">2022-12-14</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E5%AE%89%E5%85%A8/">安全</a></p><p class="item-title"><a href="/2022/11/27/Android-so%E5%8A%A0%E8%BD%BD%E5%92%8Cdump/" class="title">Android so加载和dump</a></p><p class="item-date"><time datetime="2022-11-27T10:39:13.000Z" itemprop="datePublished">2022-11-27</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-Flask源码阅读之Werkzeug" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Flask源码阅读之Werkzeug</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2023/01/30/Flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BWerkzeug/" class="article-date"><time datetime="2023-01-30T13:10:03.000Z" itemprop="datePublished">2023-01-30</time> </a></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2023/01/30/Flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BWerkzeug/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 3k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 14(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h2 id="概述"><a class="markdownIt-Anchor" href="#概述"></a> 概述</h2><p>Flask核心功能依赖于两个库：Jinja和Werkzeug。前者作为Flask的模版（Template）引擎，提供了Flask创建模版以及相关功能的支持；后者作为一个wsgi工具库，为Flask实现核心功能提供了支持。本文主要通过对Flask源码的阅读，学习下其核心功能是如何实现的，以及Werkzeug起到了一个什么作用。</p><h2 id="flask应用启动"><a class="markdownIt-Anchor" href="#flask应用启动"></a> Flask应用启动</h2><p>Flask官方建议在生产环境中，不要使用其自带的wsgi，因为并不保证安全和性能。但我们还是从启动开始研究Werkzeug的作用。</p><p>一个简单的Flask应用可能是这样的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)  </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Test succeed.&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:  </span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">76</span>)</span><br></pre></td></tr></table></figure><p>我们查看app.run内部，在其处理完参数之后，核心就是以下几句，调用werkzeug.serving模块的run_simple：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug.serving <span class="keyword">import</span> run_simple  </span><br><span class="line"><span class="keyword">try</span>:  </span><br><span class="line">    run_simple(t.cast(<span class="built_in">str</span>, host), port, self, **options)  </span><br><span class="line"><span class="keyword">finally</span>:  </span><br><span class="line">    self._got_first_request = <span class="literal">False</span></span><br></pre></td></tr></table></figure><p>我们来看下传进去的几个参数：</p><ul><li>t.cast(str, host)：调用typing.cast(typ, val)把host转成字符串类型；</li><li>port：服务占用的端口；</li><li>self：即app本身，我们用Flask()创建的Application；</li><li>options：可选项字典，例如是否是debug模式等等。</li></ul><p>继续查看run_simple的内部，我们发现如果设置<code>debug=true</code>时，会将app转换成DebuggedApplication，并且会使用run_with_reloader运行通过make_server()函数构造的server；如果不是debug执行，则直接执行server。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">run_simple</span>(<span class="params">hostname, port, application, use_reloader = <span class="literal">False</span>, use_debugger = <span class="literal">False</span>, ...</span>):</span><br><span class="line">	...省略部分代码...</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> use_debugger:  </span><br><span class="line">	    <span class="keyword">from</span> .debug <span class="keyword">import</span> DebuggedApplication  </span><br><span class="line">	    application = DebuggedApplication(application, evalex=use_evalex)</span><br><span class="line">	</span><br><span class="line">	...省略部分代码...</span><br><span class="line"></span><br><span class="line">	srv = make_server(hostname, port, application, threaded, processes, request_handler, passthrough_errors, ssl_context, fd=fd,)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> is_running_from_reloader():  </span><br><span class="line">	    srv.log_startup()  </span><br><span class="line">	    _log(<span class="string">&quot;info&quot;</span>, _ansi_style(<span class="string">&quot;Press CTRL+C to quit&quot;</span>, <span class="string">&quot;yellow&quot;</span>))  </span><br><span class="line">  </span><br><span class="line">	<span class="keyword">if</span> use_reloader:  </span><br><span class="line">	    <span class="keyword">from</span> ._reloader <span class="keyword">import</span> run_with_reloader  </span><br><span class="line">	    run_with_reloader(  </span><br><span class="line">	        srv.serve_forever,  </span><br><span class="line">	        extra_files=extra_files,  </span><br><span class="line">	        exclude_patterns=exclude_patterns,  </span><br><span class="line">	        interval=reloader_interval,  </span><br><span class="line">	        reloader_type=reloader_type,  </span><br><span class="line">	    )  </span><br><span class="line">	<span class="keyword">else</span>:  </span><br><span class="line">	    srv.serve_forever()</span><br></pre></td></tr></table></figure><p>DebuggedApplication就是将我们构造的Application封装了一层，提供了对Application进行调试的支持。当我们应用内部运行出错时会显示出一个错误页面，展示发生错误时那帧的traceback，大致如下图：</p><div align="center"><img src="https://i.328888.xyz/2023/01/31/8GNp5.md.png"></div><p>在看run_with_reloader之前，先看一下make_server函数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">make_server</span>(<span class="params">host, port, app, threaded = <span class="literal">False</span>, processes = <span class="number">1</span>, request_handler = <span class="literal">None</span>, passthrough_errors = <span class="literal">False</span>, ssl_context = <span class="literal">None</span>, fd = <span class="literal">None</span>,</span>)：</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> threaded <span class="keyword">and</span> processes &gt; <span class="number">1</span>:  </span><br><span class="line">	    <span class="keyword">raise</span> ValueError(<span class="string">&quot;Cannot have a multi-thread and multi-process server.&quot;</span>)  </span><br><span class="line">	  </span><br><span class="line">	<span class="keyword">if</span> threaded:  </span><br><span class="line">	    <span class="keyword">return</span> ThreadedWSGIServer(host, port, app, request_handler, passthrough_errors, ssl_context, fd=fd)  </span><br><span class="line">	  </span><br><span class="line">	<span class="keyword">if</span> processes &gt; <span class="number">1</span>:  </span><br><span class="line">	    <span class="keyword">return</span> ForkingWSGIServer(host,port,app,processes,request_handler,passthrough_errors,ssl_context,fd=fd,)  </span><br><span class="line">  </span><br><span class="line">	<span class="keyword">return</span> BaseWSGIServer(host, port, app, request_handler, passthrough_errors, ssl_context, fd=fd)</span><br></pre></td></tr></table></figure><p>该函数会根据传入的参数，决定返回多进程Server、多线程Server还是基础的Server，默认会返回一个基础Server。其中ThreadedWSGIServer、ForkingWSGIServer都是BaseWSGIServer的子类，BaseWSGIServer是HTTPServer的子类。</p><p>run_with_reloader这部分会用一个线程执行srv.serve_forever()，另一个线程来启动一个ReloaderLoop对象，这个对象会按设定的interval去遍历一遍项目文件，查看当前文件是否有修改，如果有则重新reload一遍。</p><p>而srv.serve_forever()则是直接使用的HTTPServer父类BaseServer的方法serve_forever()。</p><h2 id="flask路由"><a class="markdownIt-Anchor" href="#flask路由"></a> Flask路由</h2><h3 id="路由添加"><a class="markdownIt-Anchor" href="#路由添加"></a> 路由添加</h3><p>继续使用上一节中的简单Flask应用，我们用装饰器函数<code>@app.route(&quot;/&quot;)</code> 来添加了一个路由，我们查看route函数内部，发现其实际调用了Flask.add_url_rule函数来进行路由的添加：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">route</span>(<span class="params">self, rule: <span class="built_in">str</span>, **options: t.<span class="type">Any</span></span>) -&gt; t.<span class="type">Callable</span>[[T_route], T_route]:</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">f: T_route</span>) -&gt; T_route:  </span><br><span class="line">	    endpoint = options.pop(<span class="string">&quot;endpoint&quot;</span>, <span class="literal">None</span>)  </span><br><span class="line">	    self.add_url_rule(rule, endpoint, f, **options)  </span><br><span class="line">    <span class="keyword">return</span> f  </span><br><span class="line"><span class="keyword">return</span> decorator</span><br></pre></td></tr></table></figure><p>我们继续查看Flask.add_url_rule函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_url_rule</span>(<span class="params">self,rule: <span class="built_in">str</span>,endpoint = <span class="literal">None</span>,view_func = <span class="literal">None</span>,provide_automatic_options: = <span class="literal">None</span>,**options: t.<span class="type">Any</span>,</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">	</span><br><span class="line">	...省略部分代码...</span><br><span class="line"></span><br><span class="line">	rule = self.url_rule_class(rule, methods=methods, **options)  </span><br><span class="line">	rule.provide_automatic_options = provide_automatic_options  <span class="comment"># type: ignore  </span></span><br><span class="line">	  </span><br><span class="line">	self.url_map.add(rule)  </span><br><span class="line">	<span class="keyword">if</span> view_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:  </span><br><span class="line">	    old_func = self.view_functions.get(endpoint)  </span><br><span class="line">	    <span class="keyword">if</span> old_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> old_func != view_func:  </span><br><span class="line">	        <span class="keyword">raise</span> AssertionError(  </span><br><span class="line">	            <span class="string">&quot;View function mapping is overwriting an existing&quot;</span>  </span><br><span class="line">	            <span class="string">f&quot; endpoint function: <span class="subst">&#123;endpoint&#125;</span>&quot;</span>  </span><br><span class="line">	        )  </span><br><span class="line">	    self.view_functions[endpoint] = view_func</span><br></pre></td></tr></table></figure><p>在这个函数中</p><ol><li>先处理参数；</li><li>然后用werkzeug.routing.rules模块的Rule类创建路由rule对应的实例，并将其加入self.url_map中。self.url_map是werkzeug.routing.map模块的Map类创建的实例；</li><li>最后将这个路由对应的方法加入self.view_functions字典中，其key则为endpoint（endpoint默认为路由对应的函数名称）。</li></ol><p>Flask自己添加路由的部分就到此为止了，后续的路由解析、匹配等重要功能还是依托于werkzeug.routing.map模块的Map类，我们先看Map内是如何添加一个路由的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Map</span>:</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, rulefactory: <span class="string">&quot;RuleFactory&quot;</span></span>) -&gt; <span class="literal">None</span>:     </span><br><span class="line">	    <span class="keyword">for</span> rule <span class="keyword">in</span> rulefactory.get_rules(self):  </span><br><span class="line">	        rule.bind(self)  </span><br><span class="line">	        <span class="keyword">if</span> <span class="keyword">not</span> rule.build_only:  </span><br><span class="line">	            self._matcher.add(rule)  </span><br><span class="line">	        self._rules_by_endpoint.setdefault(rule.endpoint, []).append(rule)  </span><br><span class="line">	    self._remap = <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>其实很简单，就是将其Rule实例加入到自己的self._rules_by_endpoint字典中，key为endpoint。</p><h3 id="路由匹配"><a class="markdownIt-Anchor" href="#路由匹配"></a> 路由匹配</h3><p>我们添加路由以后，当一个对应的请求过来之后，Flask内部是如何处理这个请求去找到并执行对应方法的呢？我们通过对Flask这个类的代码进行阅读，梳理出主要流程如下，我们讲讲其中的关键步骤：</p><div align="center"><img src="https://i.328888.xyz/2023/02/01/IWUpL.png"></div><p>Flask在处理请求时，执行到Flask.wsgi_app函数时会创建请求的上下文对象，并将其压栈：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wsgi_app</span>(<span class="params">self, environ: <span class="built_in">dict</span>, start_response: t.<span class="type">Callable</span></span>) -&gt; t.<span class="type">Any</span>:</span><br><span class="line">	ctx = self.request_context(environ)  	<span class="comment"># 创建上下文对象</span></span><br><span class="line">	error: t.<span class="type">Optional</span>[BaseException] = <span class="literal">None</span>  </span><br><span class="line">	<span class="keyword">try</span>:  </span><br><span class="line">	    <span class="keyword">try</span>:  </span><br><span class="line">	        ctx.push()  	<span class="comment"># 压栈</span></span><br><span class="line">	        response = self.full_dispatch_request()  </span><br><span class="line">	    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:  </span><br><span class="line">	        error = e  </span><br><span class="line">	        response = self.handle_exception(e)  </span><br><span class="line">	    <span class="keyword">except</span>:  <span class="comment"># noqa: B001  </span></span><br><span class="line">	        error = sys.exc_info()[<span class="number">1</span>]  </span><br><span class="line">	        <span class="keyword">raise</span>  </span><br><span class="line">	    <span class="keyword">return</span> response(environ, start_response)  </span><br><span class="line">	<span class="keyword">finally</span>:  </span><br><span class="line">	    <span class="keyword">if</span> <span class="string">&quot;werkzeug.debug.preserve_context&quot;</span> <span class="keyword">in</span> environ:  </span><br><span class="line">	        environ[<span class="string">&quot;werkzeug.debug.preserve_context&quot;</span>](_cv_app.get())  </span><br><span class="line">	        environ[<span class="string">&quot;werkzeug.debug.preserve_context&quot;</span>](_cv_request.get())  </span><br><span class="line">	  </span><br><span class="line">	    <span class="keyword">if</span> error <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> self.should_ignore_error(error):  </span><br><span class="line">	        error = <span class="literal">None</span>  </span><br><span class="line">	  </span><br><span class="line">	    ctx.pop(error)</span><br></pre></td></tr></table></figure><p>这个RequestContext对象在初始化时会调用Flask.create_url_adapter，这个函数的主要作用是将self.url_map绑定到WSGI environment上，然后返回一个MapAdapter对象，供我们后续匹配路由。</p><p>而当RequestContext对象被push时会调用match_request，这个函数内会调用MapAdapter.match去匹配当前请求的路由。最后则会执行dispatch_request处理请求：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Flask</span>(<span class="title class_ inherited__">Scaffold</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">dispatch_request</span>(<span class="params">self</span>) -&gt; ft.ResponseReturnValue:</span><br><span class="line">		req = request_ctx.request  </span><br><span class="line">		<span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:  </span><br><span class="line">		    self.raise_routing_exception(req)  </span><br><span class="line">		rule: Rule = req.url_rule</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">getattr</span>(rule, <span class="string">&quot;provide_automatic_options&quot;</span>, <span class="literal">False</span>) <span class="keyword">and</span> req.method == <span class="string">&quot;OPTIONS&quot;</span>):  </span><br><span class="line">		    <span class="keyword">return</span> self.make_default_options_response()  </span><br><span class="line">		view_args: t.<span class="type">Dict</span>[<span class="built_in">str</span>, t.<span class="type">Any</span>] = req.view_args</span><br><span class="line">		<span class="keyword">return</span> self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)</span><br></pre></td></tr></table></figure><p>其逻辑还是非常简单易懂的，获取request对象中的路由url_rule和参数view_args，通过url_rule的endpoint去self.view_functions字典中找到对应的视图函数，然后传入参数进行执行。</p><h2 id="flask请求和响应"><a class="markdownIt-Anchor" href="#flask请求和响应"></a> Flask请求和响应</h2><p>还是以这个简单的Flask应用为例，来看看请求和响应：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)  </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():  </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>:  </span><br><span class="line">	    <span class="keyword">return</span> <span class="string">&quot;A get request.&quot;</span>  </span><br><span class="line">	<span class="keyword">elif</span> request.method == <span class="string">&quot;POST&quot;</span>:  </span><br><span class="line">	    <span class="keyword">return</span> <span class="string">&quot;A post request.&quot;</span>  </span><br><span class="line">	<span class="keyword">else</span>:  </span><br><span class="line">	    <span class="keyword">return</span> <span class="string">&quot;Test succeed.&quot;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:  </span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">76</span>)</span><br></pre></td></tr></table></figure><h3 id="请求"><a class="markdownIt-Anchor" href="#请求"></a> 请求</h3><p>我们一般直接通过import flask.globals里的request单例来获取请求的信息，例如判断请求的类型等等：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request: <span class="string">&quot;Request&quot;</span> = LocalProxy(  <span class="comment"># type: ignore[assignment]  </span></span><br><span class="line">    _cv_request, <span class="string">&quot;request&quot;</span>, unbound_message=_no_req_msg  </span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>我们查看其代码，位于flask.wrappers模块的Request类，我们发现他本身的代码很简单，主要是添加了一些蓝图、端点等内容。继续查看其父类，位于werkzeug.wrappers.request模块的Request类：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Request</span>(<span class="title class_ inherited__">_SansIORequest</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">  </span></span><br><span class="line"><span class="params">	    self,  </span></span><br><span class="line"><span class="params">	    environ: <span class="string">&quot;WSGIEnvironment&quot;</span>,  </span></span><br><span class="line"><span class="params">	    populate_request: <span class="built_in">bool</span> = <span class="literal">True</span>,  </span></span><br><span class="line"><span class="params">	    shallow: <span class="built_in">bool</span> = <span class="literal">False</span>,  </span></span><br><span class="line"><span class="params">	</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">	    <span class="built_in">super</span>().__init__(  </span><br><span class="line">	        method=environ.get(<span class="string">&quot;REQUEST_METHOD&quot;</span>, <span class="string">&quot;GET&quot;</span>),  </span><br><span class="line">	        scheme=environ.get(<span class="string">&quot;wsgi.url_scheme&quot;</span>, <span class="string">&quot;http&quot;</span>),  </span><br><span class="line">	        server=_get_server(environ),  </span><br><span class="line">	        root_path=_wsgi_decoding_dance(  </span><br><span class="line">	            environ.get(<span class="string">&quot;SCRIPT_NAME&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>, self.charset, self.encoding_errors  </span><br><span class="line">	        ),  </span><br><span class="line">	        path=_wsgi_decoding_dance(  </span><br><span class="line">	            environ.get(<span class="string">&quot;PATH_INFO&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>, self.charset, self.encoding_errors  </span><br><span class="line">	        ),  </span><br><span class="line">	        query_string=environ.get(<span class="string">&quot;QUERY_STRING&quot;</span>, <span class="string">&quot;&quot;</span>).encode(<span class="string">&quot;latin1&quot;</span>),  </span><br><span class="line">	        headers=EnvironHeaders(environ),  </span><br><span class="line">	        remote_addr=environ.get(<span class="string">&quot;REMOTE_ADDR&quot;</span>),  </span><br><span class="line">	    )  </span><br><span class="line">	    self.environ = environ  </span><br><span class="line">	    self.shallow = shallow  </span><br><span class="line">	  </span><br><span class="line">	    <span class="keyword">if</span> populate_request <span class="keyword">and</span> <span class="keyword">not</span> shallow:  </span><br><span class="line">	        self.environ[<span class="string">&quot;werkzeug.request&quot;</span>] = self</span><br></pre></td></tr></table></figure><p>从其初始化函数中我们可以看到，Request会从WSGIEnvironment中读取相关信息，例如REQUEST_METHOD等等。</p><h3 id="响应"><a class="markdownIt-Anchor" href="#响应"></a> 响应</h3><p>继续回到我们这一节的简单应用，假如客户端发送了一个GET类型的request，我们将返回一个<code>“A get request.”</code>字符串，返回的这个字符串是如何响应到客户端的呢？</p><p>我们回到“路由匹配”那个执行图的Flask.full_dispatch_request函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">full_dispatch_request</span>(<span class="params">self</span>) -&gt; Response:</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> self._got_first_request:  </span><br><span class="line">	    <span class="keyword">with</span> self._before_request_lock:  </span><br><span class="line">	        <span class="keyword">if</span> <span class="keyword">not</span> self._got_first_request:  </span><br><span class="line">	            <span class="keyword">for</span> func <span class="keyword">in</span> self.before_first_request_funcs:  </span><br><span class="line">	                self.ensure_sync(func)()    </span><br><span class="line">	            self._got_first_request = <span class="literal">True</span>    </span><br><span class="line">	<span class="keyword">try</span>:  </span><br><span class="line">	    request_started.send(self)  </span><br><span class="line">	    rv = self.preprocess_request()  </span><br><span class="line">	    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:  </span><br><span class="line">	        rv = self.dispatch_request()  </span><br><span class="line">	<span class="keyword">except</span> Exception <span class="keyword">as</span> e:  </span><br><span class="line">	    rv = self.handle_user_exception(e)  </span><br><span class="line">	<span class="keyword">return</span> self.finalize_request(rv)	<span class="comment"># 最后将路由对应的视图函数执行结果进行处理</span></span><br></pre></td></tr></table></figure><p>在这个函数的最后，会把视图函数执行的结果传入finalize_request函数中进行处理。我们来看下这个函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">finalize_request</span>(<span class="params">  </span></span><br><span class="line"><span class="params">    self,  </span></span><br><span class="line"><span class="params">    rv: t.<span class="type">Union</span>[ft.ResponseReturnValue, HTTPException],  </span></span><br><span class="line"><span class="params">    from_error_handler: <span class="built_in">bool</span> = <span class="literal">False</span>,  </span></span><br><span class="line"><span class="params"></span>) -&gt; Response:</span><br><span class="line">	response = self.make_response(rv)  </span><br><span class="line">	<span class="keyword">try</span>:  </span><br><span class="line">	    response = self.process_response(response)  </span><br><span class="line">	    request_finished.send(self, response=response)  </span><br><span class="line">	<span class="keyword">except</span> Exception:  </span><br><span class="line">	    <span class="keyword">if</span> <span class="keyword">not</span> from_error_handler:  </span><br><span class="line">	        <span class="keyword">raise</span>  </span><br><span class="line">	    self.logger.exception(  </span><br><span class="line">	        <span class="string">&quot;Request finalizing failed with an error while handling an error&quot;</span>  </span><br><span class="line">	    )  </span><br><span class="line">	<span class="keyword">return</span> response</span><br></pre></td></tr></table></figure><p>这个函数主要功能，先通过make_response创建出Response对象，然后执行process_response来对Response对象进行处理，例如执行hook函数等。</p><p>Response类位于flask.wrappers，其代码很少，主要功能还是在父类werkzeug.wrappers.response模块的Response类中。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Response</span>(<span class="title class_ inherited__">_SansIOResponse</span>):</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">  </span></span><br><span class="line"><span class="params">	    self,  </span></span><br><span class="line"><span class="params">	    response: t.<span class="type">Optional</span>[  </span></span><br><span class="line"><span class="params">	        t.<span class="type">Union</span>[t.Iterable[<span class="built_in">bytes</span>], <span class="built_in">bytes</span>, t.Iterable[<span class="built_in">str</span>], <span class="built_in">str</span>]  </span></span><br><span class="line"><span class="params">	    ] = <span class="literal">None</span>,  </span></span><br><span class="line"><span class="params">	    status: t.<span class="type">Optional</span>[t.<span class="type">Union</span>[<span class="built_in">int</span>, <span class="built_in">str</span>, HTTPStatus]] = <span class="literal">None</span>,  </span></span><br><span class="line"><span class="params">	    headers: t.<span class="type">Optional</span>[  </span></span><br><span class="line"><span class="params">	        t.<span class="type">Union</span>[  </span></span><br><span class="line"><span class="params">	            t.Mapping[<span class="built_in">str</span>, t.<span class="type">Union</span>[<span class="built_in">str</span>, <span class="built_in">int</span>, t.Iterable[t.<span class="type">Union</span>[<span class="built_in">str</span>, <span class="built_in">int</span>]]]],  </span></span><br><span class="line"><span class="params">	            t.Iterable[t.<span class="type">Tuple</span>[<span class="built_in">str</span>, t.<span class="type">Union</span>[<span class="built_in">str</span>, <span class="built_in">int</span>]]],  </span></span><br><span class="line"><span class="params">	        ]  </span></span><br><span class="line"><span class="params">	    ] = <span class="literal">None</span>,  </span></span><br><span class="line"><span class="params">	    mimetype: t.<span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,  </span></span><br><span class="line"><span class="params">	    content_type: t.<span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,  </span></span><br><span class="line"><span class="params">	    direct_passthrough: <span class="built_in">bool</span> = <span class="literal">False</span>,  </span></span><br><span class="line"><span class="params">	</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">	    <span class="built_in">super</span>().__init__(  </span><br><span class="line">	        status=status,  </span><br><span class="line">	        headers=headers,  </span><br><span class="line">	        mimetype=mimetype,  </span><br><span class="line">	        content_type=content_type,  </span><br><span class="line">	    )</span><br><span class="line">	    self.direct_passthrough = direct_passthrough  </span><br><span class="line">		self._on_close: t.<span class="type">List</span>[t.<span class="type">Callable</span>[[], t.<span class="type">Any</span>]] = []</span><br><span class="line">		<span class="keyword">if</span> response <span class="keyword">is</span> <span class="literal">None</span>:  </span><br><span class="line">		    self.response = []  </span><br><span class="line">		<span class="keyword">elif</span> <span class="built_in">isinstance</span>(response, (<span class="built_in">str</span>, <span class="built_in">bytes</span>, <span class="built_in">bytearray</span>)):  </span><br><span class="line">		    self.set_data(response)  </span><br><span class="line">		<span class="keyword">else</span>:  </span><br><span class="line">		    self.response = response</span><br></pre></td></tr></table></figure><p>其初始化时会设置返回状态码、headers、数据等等。</p><h2 id="flask上下文管理"><a class="markdownIt-Anchor" href="#flask上下文管理"></a> Flask上下文管理</h2><p>我们在使用request的时候，发现有用到flask.globals模块，这里面主要有两块内容：Application Context及其全局变量、Request Context及其全局变量。Application Context是在启动app时会初始化的上下文对象，内部存放整体的信息；Request Context存放处理请求时的context，当该次请求处理完时也会销毁。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Application Context 内容</span></span><br><span class="line">_cv_app: ContextVar[<span class="string">&quot;AppContext&quot;</span>] = ContextVar(<span class="string">&quot;flask.app_ctx&quot;</span>)  </span><br><span class="line">__app_ctx_stack = _FakeStack(<span class="string">&quot;app&quot;</span>, _cv_app)  </span><br><span class="line">app_ctx: <span class="string">&quot;AppContext&quot;</span> = LocalProxy(  <span class="comment"># type: ignore[assignment]  </span></span><br><span class="line">    _cv_app, unbound_message=_no_app_msg  </span><br><span class="line">)  </span><br><span class="line">current_app: <span class="string">&quot;Flask&quot;</span> = LocalProxy(  <span class="comment"># type: ignore[assignment]  </span></span><br><span class="line">    _cv_app, <span class="string">&quot;app&quot;</span>, unbound_message=_no_app_msg  </span><br><span class="line">)  </span><br><span class="line">g: <span class="string">&quot;_AppCtxGlobals&quot;</span> = LocalProxy(  <span class="comment"># type: ignore[assignment]  </span></span><br><span class="line">    _cv_app, <span class="string">&quot;g&quot;</span>, unbound_message=_no_app_msg  </span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Request Context 内容</span></span><br><span class="line">_cv_request: ContextVar[<span class="string">&quot;RequestContext&quot;</span>] = ContextVar(<span class="string">&quot;flask.request_ctx&quot;</span>)  </span><br><span class="line">__request_ctx_stack = _FakeStack(<span class="string">&quot;request&quot;</span>, _cv_request)  </span><br><span class="line">request_ctx: <span class="string">&quot;RequestContext&quot;</span> = LocalProxy(  <span class="comment"># type: ignore[assignment]  </span></span><br><span class="line">    _cv_request, unbound_message=_no_req_msg  </span><br><span class="line">)  </span><br><span class="line">request: <span class="string">&quot;Request&quot;</span> = LocalProxy(  <span class="comment"># type: ignore[assignment]  </span></span><br><span class="line">    _cv_request, <span class="string">&quot;request&quot;</span>, unbound_message=_no_req_msg  </span><br><span class="line">)  </span><br><span class="line">session: <span class="string">&quot;SessionMixin&quot;</span> = LocalProxy(  <span class="comment"># type: ignore[assignment]  </span></span><br><span class="line">    _cv_request, <span class="string">&quot;session&quot;</span>, unbound_message=_no_req_msg  </span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>我们知道全局变量是不可改变的，因此Flask用到了werkzeug.local模块来实现这种类似全局变量的东西，同时兼顾了多线程。我们先来看下local模块的基础类Local：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Local</span>:</span><br><span class="line">	__slots__ = (<span class="string">&quot;__storage&quot;</span>,)  </span><br><span class="line">  </span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">  </span></span><br><span class="line"><span class="params">	    self, context_var: t.<span class="type">Optional</span>[ContextVar[t.<span class="type">Dict</span>[<span class="built_in">str</span>, t.<span class="type">Any</span>]]] = <span class="literal">None</span>  </span></span><br><span class="line"><span class="params">	</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">	    <span class="keyword">if</span> context_var <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		    context_var = ContextVar(<span class="string">f&quot;werkzeug.Local&lt;<span class="subst">&#123;<span class="built_in">id</span>(self)&#125;</span>&gt;.storage&quot;</span>)</span><br><span class="line">		<span class="built_in">object</span>.__setattr__(self, <span class="string">&quot;_Local__storage&quot;</span>, context_var)</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">  </span></span><br><span class="line"><span class="params">	    self, name: <span class="built_in">str</span>, *, unbound_message: t.<span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>  </span></span><br><span class="line"><span class="params">	</span>) -&gt; <span class="string">&quot;LocalProxy&quot;</span>:</span><br><span class="line">		<span class="keyword">return</span> LocalProxy(self, name, unbound_message=unbound_message)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__release_local__</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">	    self.__storage.<span class="built_in">set</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, name: <span class="built_in">str</span></span>) -&gt; t.<span class="type">Any</span>:  </span><br><span class="line">	    values = self.__storage.get(&#123;&#125;)  </span><br><span class="line">	  </span><br><span class="line">	    <span class="keyword">if</span> name <span class="keyword">in</span> values:  </span><br><span class="line">	        <span class="keyword">return</span> values[name]  </span><br><span class="line">	  </span><br><span class="line">	    <span class="keyword">raise</span> AttributeError(name)  </span><br><span class="line">  </span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__setattr__</span>(<span class="params">self, name: <span class="built_in">str</span>, value: t.<span class="type">Any</span></span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">	    values = self.__storage.get(&#123;&#125;).copy()  </span><br><span class="line">	    values[name] = value  </span><br><span class="line">	    self.__storage.<span class="built_in">set</span>(values)</span><br></pre></td></tr></table></figure><p>Local通过self.__storage来存储数据，其本身是一个dict。context_var则根据类型可以传入AppContext或者RequestContext。线程安全主要通过LocalProxy来实现。</p><p>LocalStack类其实也类似，是一个线程安全的栈对象，也是通过LocalProxy来实现线程安全。</p><p>LocalProxy类：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LocalProxy</span>(t.<span class="type">Generic</span>[T]):</span><br><span class="line">	__slots__ = (<span class="string">&quot;__wrapped&quot;</span>, <span class="string">&quot;_get_current_object&quot;</span>)  </span><br><span class="line">	_get_current_object: t.<span class="type">Callable</span>[[], T]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">  </span></span><br><span class="line"><span class="params">	    self,  </span></span><br><span class="line"><span class="params">	    local: t.<span class="type">Union</span>[ContextVar[T], Local, LocalStack[T], t.<span class="type">Callable</span>[[], T]],  </span></span><br><span class="line"><span class="params">	    name: t.<span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,  </span></span><br><span class="line"><span class="params">	    *,  </span></span><br><span class="line"><span class="params">	    unbound_message: t.<span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,  </span></span><br><span class="line"><span class="params">	</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">	    <span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span>:  </span><br><span class="line">	        get_name = _identity  </span><br><span class="line">	    <span class="keyword">else</span>:  </span><br><span class="line">	        get_name = attrgetter(name)  <span class="comment"># type: ignore[assignment]  </span></span><br><span class="line">	  </span><br><span class="line">	    <span class="keyword">if</span> unbound_message <span class="keyword">is</span> <span class="literal">None</span>:  </span><br><span class="line">	        unbound_message = <span class="string">&quot;object is not bound&quot;</span>  </span><br><span class="line">	  </span><br><span class="line">	    <span class="keyword">if</span> <span class="built_in">isinstance</span>(local, Local):  </span><br><span class="line">	        <span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span>:  </span><br><span class="line">	            <span class="keyword">raise</span> TypeError(<span class="string">&quot;&#x27;name&#x27; is required when proxying a &#x27;Local&#x27; object.&quot;</span>)    </span><br><span class="line">	        <span class="keyword">def</span> <span class="title function_">_get_current_object</span>() -&gt; T:  </span><br><span class="line">	            <span class="keyword">try</span>:  </span><br><span class="line">	                <span class="keyword">return</span> get_name(local)  <span class="comment"># type: ignore[<span class="keyword">return</span>-value]  </span></span><br><span class="line">	            <span class="keyword">except</span> AttributeError:  </span><br><span class="line">	                <span class="keyword">raise</span> RuntimeError(unbound_message) <span class="keyword">from</span> <span class="literal">None</span>  </span><br><span class="line">	  </span><br><span class="line">	    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(local, LocalStack):  	  </span><br><span class="line">	        <span class="keyword">def</span> <span class="title function_">_get_current_object</span>() -&gt; T:  </span><br><span class="line">	            obj = local.top  <span class="comment"># type: ignore[union-attr]  	  </span></span><br><span class="line">	            <span class="keyword">if</span> obj <span class="keyword">is</span> <span class="literal">None</span>:  </span><br><span class="line">	                <span class="keyword">raise</span> RuntimeError(unbound_message)    </span><br><span class="line">	            <span class="keyword">return</span> get_name(obj)  </span><br><span class="line">	  </span><br><span class="line">	    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(local, ContextVar):    </span><br><span class="line">	        <span class="keyword">def</span> <span class="title function_">_get_current_object</span>() -&gt; T:  </span><br><span class="line">	            <span class="keyword">try</span>:  </span><br><span class="line">	                obj = local.get()  <span class="comment"># type: ignore[union-attr]  </span></span><br><span class="line">	            <span class="keyword">except</span> LookupError:  </span><br><span class="line">	                <span class="keyword">raise</span> RuntimeError(unbound_message) <span class="keyword">from</span> <span class="literal">None</span>    </span><br><span class="line">	            <span class="keyword">return</span> get_name(obj)  </span><br><span class="line">	  </span><br><span class="line">	    <span class="keyword">elif</span> <span class="built_in">callable</span>(local):  </span><br><span class="line">	        <span class="keyword">def</span> <span class="title function_">_get_current_object</span>() -&gt; T:  </span><br><span class="line">	            <span class="keyword">return</span> get_name(local())  <span class="comment"># type: ignore  	  </span></span><br><span class="line">	    <span class="keyword">else</span>:  </span><br><span class="line">	        <span class="keyword">raise</span> TypeError(<span class="string">f&quot;Don&#x27;t know how to proxy &#x27;<span class="subst">&#123;<span class="built_in">type</span>(local)&#125;</span>&#x27;.&quot;</span>)  </span><br><span class="line">	  </span><br><span class="line">	    <span class="built_in">object</span>.__setattr__(self, <span class="string">&quot;_LocalProxy__wrapped&quot;</span>, local)  </span><br><span class="line">	    <span class="built_in">object</span>.__setattr__(self, <span class="string">&quot;_get_current_object&quot;</span>, _get_current_object)  </span><br><span class="line"> </span><br><span class="line">	__wrapped__ = _ProxyLookup(  </span><br><span class="line">	    fallback=<span class="keyword">lambda</span> self: self._LocalProxy__wrapped, is_attr=<span class="literal">True</span>  </span><br><span class="line">	)</span><br></pre></td></tr></table></figure><p>LocalProxy主要起到获取当前Local对象，然后将对自己的操作转发给这个Local对象。</p></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="http://example.com/2023/01/30/Flask%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BWerkzeug/" title="Flask源码阅读之Werkzeug" target="_blank" rel="external">http://example.com/2023/01/30/Flask源码阅读之Werkzeug/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/Seventysix" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/Seventysix" target="_blank"><span class="text-dark">Seventysix</span><small class="ml-1x">高级测试开发工程师</small></a></h3><div>目前在一家游戏公司从事游戏安全与测试开发相关工作。</div></div></figure></div></div></div></article><section id="comments"><div id="lv-container" data-id="city" data-uid="MTAyMC81Nzk2OS8zNDQzMg=="><noscript>为正常使用来必力评论功能请激活JavaScript</noscript></div></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="next"><a href="/2023/01/25/Flask%E5%BB%BA%E7%AB%99%E8%87%AA%E7%94%A8%E6%A0%87%E9%85%8D/" title="Flask建站自用标配"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/Seventysix" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li></ul><div class="copyright">&copy; 2023 Seventysix<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script defer type="text/javascript">!function(e,t){var n=e.getElementsByTagName(t)[0];"function"!=typeof LivereTower&&((e=e.createElement(t)).src="https://cdn-city.livere.com/js/embed.dist.js",e.async=!0,n.parentNode.insertBefore(e,n))}(document,"script")</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a,t,n=$(this),e=n.attr("alt"),r=n.parent("a");r.length<1&&(-1!=(t=(a=this.getAttribute("src")).lastIndexOf("?"))&&(a=a.substring(0,t)),r=n.wrap('<a href="'+a+'"></a>').parent("a")),r.attr("data-fancybox","images"),e&&r.attr("data-caption",e)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script></body></html>